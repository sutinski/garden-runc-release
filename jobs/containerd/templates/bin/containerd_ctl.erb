#!/bin/bash

set -e

JOB_NAME=containerd
RUN_DIR=/var/vcap/sys/run/$JOB_NAME
LOG_DIR=/var/vcap/sys/log/$JOB_NAME
DATA_DIR=/var/vcap/data/$JOB_NAME
STATE_DIR=/var/vcap/store/$JOB_NAME
PID_FILEPATH=$RUN_DIR/$JOB_NAME.pid
CONFIG_FILEPATH=/var/vcap/jobs/$JOB_NAME/config/containerd.toml
ROOTLESS_CONFIG_FILEPATH=/var/vcap/data/containerd/containerd.toml

export PATH=$PATH:/var/vcap/packages/containerd/bin
export PATH=$PATH:/var/vcap/packages/runc/bin
export PATH="/var/vcap/packages/garden-idmapper/bin:${PATH}"

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/var/vcap/packages/libseccomp/lib

export XDG_RUNTIME_DIR=/var/run/user/maximus

create_maximus() {
  groupadd -g 4294967294 maximus || true
  useradd -u 4294967294 maximus -g maximus || true
}

create_configfile() {
  cp $CONFIG_FILEPATH $ROOTLESS_CONFIG_FILEPATH
  chown 4294967294:4294967294 $ROOTLESS_CONFIG_FILEPATH
}

create_dirs() {
  mkdir -p $RUN_DIR $LOG_DIR $DATA_DIR $STATE_DIR
  chown 4294967294:4294967294 $RUN_DIR $LOG_DIR $DATA_DIR $STATE_DIR

  mkdir -p /run/containerd
  chmod 700 /run/containerd
  chown 4294967294:4294967294 /run/containerd

  mkdir -p $XDG_RUNTIME_DIR
  chmod 700 $XDG_RUNTIME_DIR
  chown maximus:maximus $XDG_RUNTIME_DIR
}

write_pidfile() {
  echo $$ > $PID_FILEPATH
}

start_containerd() {
  log "starting containerd"
  exec 1>> $LOG_DIR/containerd.stdout.log
  exec 2>> $LOG_DIR/containerd.stderr.log
  exec containerd -c $CONFIG_FILEPATH
}

start_containerd_rootless() {
  log "starting containerd"
  exec 1>> $LOG_DIR/containerd.stdout.log
  exec 2>> $LOG_DIR/containerd.stderr.log
  exec chpst -u maximus:maximus containerd -c $ROOTLESS_CONFIG_FILEPATH
}

stop_containerd() {
  log "stopping containerd"
  kill "$(cat $PID_FILEPATH)"
  rm -f $PID_FILEPATH
}

log() {
  local msg
  local time

  msg=$1
  time=$(date +"%e/%m/%Y - %T")

  echo "$time $msg" >> $LOG_DIR/containerd_ctl.log
}

case $1 in
  start)
    create_maximus
    create_dirs
    create_configfile
    write_pidfile
#    start_containerd
    start_containerd_rootless
  ;;

  stop)
    stop_containerd
  ;;

  *)
    echo "Usage: $0 {start|stop}"
    exit 1
  ;;
esac
